# ユーザーマニュアル

## 概要

React DB Plugin は WordPress 上でカスタムデータベーステーブルや CSV データを管理できるプラグインです。React 製のインターフェースから CSV のインポート／エクスポート、テーブル編集、操作ログ閲覧、データ出力設定などが行えます。保存したデータは REST API やショートコードを介して取得・表示することも可能です。

## インストール

1. **JavaScript 依存パッケージのインストール**
   ```bash
   npm install
   ```
2. **React アプリケーションのビルド**
   ```bash
   npm run build
   ```
   ビルド後は `scripts/copy-build.js` により生成物が `react-db-plugin/assets` に `app.js` と `app.css` としてコピーされます。
3. **WordPress への配置**
   `react-db-plugin` ディレクトリを WordPress の `wp-content/plugins` に移動し、管理画面から **React DB Plugin** を有効化します。有効化すると `/react-db-app/` ページが作成され、React インターフェースが読み込まれます。操作ログ用の `wp_reactdb_logs` テーブルも自動で作成されます。

## インターフェースへのアクセス

* **管理画面メニュー** – プラグインを有効化すると WordPress ダッシュボードに「React DB」メニューが表示されます。ここから React アプリを起動できます。
* **フロントエンドページ** – ログインした状態で `/react-db-app/` を開くと、同じインターフェースを管理画面外で利用できます。ページが存在しない場合は新規ページを作成し、`[reactdb_app]` ショートコードを挿入してください。

React UI はヘッダー、サイドバー、複数のツールで構成されています。

- **CSV インポート** – CSV ファイルをアップロードして新しいテーブルを作成します。テーブル名を指定しない場合はファイル名が使用されます。最初の 100 行からカラム型を自動判定します。
- **CSV エクスポート** – 既存のテーブルを選択して CSV 形式でダウンロードできます。
- **DB 登録** – テーブル名とカラム定義、デフォルト値、`created_at`/`updated_at` の自動追加などを設定して新規テーブルを作成します。
- **データベース一覧** – 既存テーブルの閲覧、コピー、削除、行の表示・編集ができます。`logs` など保護されたテーブルは削除できません。
- **操作ログ** – `wp_reactdb_logs` に記録された最近の操作を確認できます。ユーザー ID や説明が保存されています。
- **出力設定** – テーブルデータを JSON または HTML として出力するタスクを定義します。HTML スニペットでは `{{column}}` プレースホルダーを利用でき、`[reactdb_output task="taskName"]` で表示可能です。HTML 形式の場合は表示に使いたい「日付カラム」と「カテゴリカラム」を選択でき、前者は日付タブ、後者はカテゴリタブとしてショートコード出力に反映されます。

## テーブル編集

**データベース一覧** からテーブルを選択すると内容を表示できます。各行には削除や編集ボタンがあり、編集フォームでは値の変更や新規行の追加を行います。自動採番 ID やタイムスタンプ列などの読み取り専用フィールドは変更できません。保存時は `/wp-json/reactdb/v1` REST API へ認証用ノンス付きでリクエストが送信されます。

新しいテーブルを作成する場合は **DB 登録** 画面を開きます。テーブル名とともに INT、VARCHAR(255)、TEXT、DATETIME などのカラムを追加し、必要に応じて `created_at` と `updated_at` フィールドを自動生成できます。

## 出力 API

**出力設定** で登録したタスクは次の方法で取得できます。

- JSON 形式: `https://your-site.com/wp-json/reactdb/v1/output/<task>`
- HTML 形式: `[reactdb_output task="<task>"]`

これらのエンドポイントは対象テーブルの全行を返します。HTML 形式では保存されたスニペットをもとにリストが生成されます。タスクの設定は WordPress オプション `reactdb_output_settings` に保存されています。

## タブフィルター付きショートコードの使い方

HTML 出力タスクでは複数のフィルターグループを追加でき、各グループごとに「どのカラムを参照するか」「値をどのように扱うか」「どの順番で並べるか」を細かく調整できます。設定したフィルターはショートコードの表示時にタブ UI として自動生成され、選択した条件に一致する行のみが表示されます。

1. **出力設定 → タスク編集** で対象テーブルを選び、フォーマットに「HTML」を指定します。
2. 「フィルターを追加」を押してグループを作成し、以下を設定します。
   - **グループ名** – タブグループの見出しとして表示されます。
   - **参照カラム** – 絞り込み対象となるテーブルの列を選択します。
   - **参照方法** – 値の扱い方を選びます。
     - 「値をそのまま使用」: 列のユニーク値をそのままタブにします。
     - 「日付としてフォーマット」: `Y-m` や `Y年n月` など PHP の `date` 形式でまとめます。
     - 「区切り文字で分割」: `,` や `|` などの区切りで複数値を含む列を分割し、いずれかに一致すれば表示します。
   - **タブラベルテンプレート** – `{{value}}` プレースホルダーを含めてタブの表示名を整形できます（例: `カテゴリ: {{value}}`）。
   - **並び順** – タブの表示順を昇順 / 降順 / 取得順から選べます。
3. 必要に応じて HTML テンプレートや CSS を調整し、「保存」を押します。複数のフィルターを追加した場合は、それぞれのタブ選択が組み合わさって絞り込みが適用されます。
4. フロントエンドでは `[reactdb_output task="<task>"]` を挿入すると、設定したフィルターごとにタブボタンが表示されます。「すべて」をクリックするとそのフィルターだけ条件が解除されます。

タブ UI のスタイルは `react-db-plugin/assets/output-tabs.css` に定義されています。上書きしたい場合はテーマやカスタマイザーに任意の CSS を追加してください。JavaScript の挙動は `react-db-plugin/assets/output-tabs.js` に実装されており、ページ読込後に自動実行されます。新しいコンテンツを Ajax などで追加した際は、以下のように公開されているグローバル API を使って再初期化できます。

```html
<script>
  fetch('/wp-json/reactdb/v1/output/events')
    .then(response => response.text())
    .then(html => {
      const container = document.querySelector('#event-output');
      container.innerHTML = html;
      if (window.ReactDBOutputTabs) {
        window.ReactDBOutputTabs.init();
      }
    });
</script>
```

個別の要素に対して初期化したい場合は `window.ReactDBOutputTabs.setup(element)` を、監視を有効化したい場合は `window.ReactDBOutputTabs.observe()` を利用できます。監視は MutationObserver を利用しており、DOM にタブ UI が追加されるたびに自動で初期化されます。

## その他のショートコード

- `[reactdb input='DB:"table",data']` – 指定したテーブルの先頭行を表示します。
- `[reactdb_app]` – 前述の React インターフェース全体を任意のページに埋め込むショートコードです（`/react-db-app/` ページでも利用）。

## アンインストール

プラグインを削除すると `wp_reactdb_logs` テーブルと `/react-db-app/` ページは自動的に削除されます。

## プラグイン情報の更新

表示されるバージョンや作者を変更する場合は `react-db-plugin/react-db-plugin.php` を編集してください。React アプリ側のバージョン番号を更新する場合は `package.json` の `"version"` を変更し、再度 `npm run build` を実行して反映させます。

## テスト

必要な依存関係が整っていれば `npm test` でテストを実行できます。この環境では `react-scripts` がインストールされていないため、テストは失敗します。
